<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠã—ã”ã¨äºˆå ± - Spray Forecast</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ¿ èŠã—ã”ã¨äºˆå ±</h1>
            <p class="subtitle">æ°—è±¡äºˆæ¸¬ã‹ã‚‰è¾²è–¬ãƒ»è‚¥æ–™æ•£å¸ƒã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã‚¢ãƒ‰ãƒã‚¤ã‚¹</p>
        </header>

        <div class="location-input">
            <h2>å ´æ‰€ã‚’æŒ‡å®š</h2>
            <div class="input-group">
                <label for="lat">ç·¯åº¦ (Latitude):</label>
                <input type="number" id="lat" step="0.0001" value="35.5" placeholder="ä¾‹: 35.5">
                
                <label for="lon">çµŒåº¦ (Longitude):</label>
                <input type="number" id="lon" step="0.0001" value="139.6" placeholder="ä¾‹: 139.6">
                
                <button id="search-btn" onclick="fetchForecast()">äºˆå ±ã‚’å–å¾—</button>
            </div>
            <p class="help-text">â€» ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</p>
            <button id="current-location-btn" onclick="getCurrentLocation()" class="secondary">ç¾åœ¨åœ°ã‚’ä½¿ç”¨</button>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>æ°—è±¡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
        </div>

        <div id="error" class="error hidden"></div>

        <div id="results" class="results hidden">
            <h2>æ•£å¸ƒå¯èƒ½ã‚¿ã‚¤ãƒŸãƒ³ã‚°</h2>
            <div id="forecast-table" class="forecast-table-container"></div>
        </div>

        <div class="legend">
            <h3>å‡¡ä¾‹</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="status-badge green">GREEN</span>
                    <span>æ•£å¸ƒæ¨å¥¨ - æ¡ä»¶è‰¯å¥½</span>
                </div>
                <div class="legend-item">
                    <span class="status-badge yellow">YELLOW</span>
                    <span>æ³¨æ„ - æ¡ä»¶ã«æ³¨æ„ãŒå¿…è¦</span>
                </div>
                <div class="legend-item">
                    <span class="status-badge red">RED</span>
                    <span>éæ¨å¥¨ - æ•£å¸ƒã‚’é¿ã‘ã‚‹</span>
                </div>
            </div>
        </div>

        <footer>
            <p>æ°—è±¡ãƒ‡ãƒ¼ã‚¿æä¾›: <a href="https://www.met.no/" target="_blank">MET Norway</a></p>
            <p>æ¨å¥¨æ•£å¸ƒæ™‚é–“å¸¯: æ—©æœ 4-7æ™‚ã€å¤•æ–¹ 16-19æ™‚</p>
        </footer>
    </div>

    <script>
        async function fetchForecast() {
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;
            
            if (!lat || !lon) {
                showError('ç·¯åº¦ã¨çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                const response = await fetch(`/api/forecast?lat=${lat}&lon=${lon}`);
                const data = await response.json();

                if (data.success) {
                    displayResults(data.results);
                } else {
                    showError(data.error || 'äºˆå ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function displayResults(results) {
            const container = document.getElementById('forecast-table');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<p class="no-results">è©²å½“ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                document.getElementById('results').classList.remove('hidden');
                return;
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // æ™‚é–“å¸¯ã®å®šç¾©ï¼ˆ1æ—¥ã®ã™ã¹ã¦ã®æ™‚é–“å¸¯ã‚’è¡¨ç¤ºï¼‰
            // æ•£å¸ƒå¯èƒ½æ™‚é–“å¸¯: æ—©æœ4-7æ™‚ã€å¤•æ–¹16-19æ™‚
            const timeSlots = [];
            // æ—©æœ: 4:00ï½7:00
            for (let h = 4; h <= 7; h++) {
                timeSlots.push({ hour: h, label: `${h}:00` });
            }
            // åˆå‰: 8:00ï½15:00
            for (let h = 8; h <= 15; h++) {
                timeSlots.push({ hour: h, label: `${h}:00` });
            }
            // å¤•æ–¹: 16:00ï½19:00
            for (let h = 16; h <= 19; h++) {
                timeSlots.push({ hour: h, label: `${h}:00` });
            }
            // å¤œ: 20:00ï½23:00
            for (let h = 20; h <= 23; h++) {
                timeSlots.push({ hour: h, label: `${h}:00` });
            }

            // æ—¥ä»˜ã®é…åˆ—ï¼ˆä»Šæ—¥ã‹ã‚‰3æ—¥é–“ï¼‰
            const dates = [];
            const dayLabels = ['ä»Šæ—¥', 'æ˜æ—¥', 'æ˜å¾Œæ—¥'];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                dates.push({
                    date: date,
                    label: dayLabels[i],
                    dateStr: date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' })
                });
            }

            // resultsã‚’æ—¥ä»˜ã¨æ™‚é–“ã§ãƒãƒƒãƒ—ã«å¤‰æ›
            // APIã‹ã‚‰è¿”ã•ã‚Œã‚‹æ™‚åˆ»ã¯JSTï¼ˆbackendã§å¤‰æ›æ¸ˆã¿ï¼‰ã¨ã—ã¦æ‰±ã†
            const resultMap = new Map();
            const dateSet = new Set();  // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æ—¥ä»˜ã‚’è¨˜éŒ²
            results.forEach(result => {
                const dt = new Date(result.time);  // JSTæ™‚åˆ»ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ä»˜ãï¼‰
                // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã¨æ™‚åˆ»ã‚’å–å¾—ï¼ˆJSTï¼‰
                const year = dt.getFullYear();
                const month = dt.getMonth();
                const date = dt.getDate();
                const hour = dt.getHours();  // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã®æ™‚é–“ï¼ˆJSTï¼‰
                
                // æ—¥ä»˜ã‚­ãƒ¼ï¼ˆæ—¥ä»˜ã®ã¿ï¼‰- YYYY-MM-DDå½¢å¼ã§çµ±ä¸€ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ï¼‰
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                dateSet.add(dateKey);  // ãƒ‡ãƒãƒƒã‚°ç”¨
                // ãƒãƒƒãƒ—ã‚­ãƒ¼ã¯æ—¥ä»˜_æ™‚é–“ã®å½¢å¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã®æ™‚é–“ã‚’ä½¿ç”¨ï¼‰
                const mapKey = `${dateKey}_${hour}`;
                resultMap.set(mapKey, result);
            });
            
            // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æ—¥ä»˜ã‚’ç¢ºèª
            console.log('Dates with data:', Array.from(dateSet).sort());
            console.log('Expected dates:', dates.map(d => {
                const year = d.date.getFullYear();
                const month = d.date.getMonth();
                const date = d.date.getDate();
                return `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
            }));

            // è¡¨ã®ä½œæˆ
            let tableHTML = '<table class="forecast-table"><thead><tr><th class="time-header">æ™‚é–“</th>';
            dates.forEach(d => {
                tableHTML += `<th class="date-header">${d.label}<br><span class="date-sub">${d.dateStr}</span></th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            timeSlots.forEach(timeSlot => {
                tableHTML += '<tr>';
                tableHTML += `<td class="time-cell">${timeSlot.label}</td>`;
                
                dates.forEach(dateInfo => {
                    const slotDate = new Date(dateInfo.date);
                    slotDate.setHours(timeSlot.hour, 0, 0, 0);
                    
                    // éå»ã‹ã©ã†ã‹åˆ¤å®š
                    const isPast = slotDate < now;
                    
                    // æ—¥ä»˜ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆå¹´æœˆæ—¥ã®ã¿ï¼‰- YYYY-MM-DDå½¢å¼ã§çµ±ä¸€ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ï¼‰
                    const year = slotDate.getFullYear();
                    const month = slotDate.getMonth();
                    const date = slotDate.getDate();
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                    // æ¤œç´¢ã‚­ãƒ¼ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«æ™‚åˆ»ã®æ™‚é–“ã‚’ä½¿ç”¨
                    const mapKey = `${dateKey}_${timeSlot.hour}`;
                    
                    const result = resultMap.get(mapKey);
                    
                    // æ•£å¸ƒå¯èƒ½æ™‚é–“å¸¯ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆresultã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã°ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§åˆ¤å®šï¼‰
                    const isSprayTime = result ? (result.is_spray_time !== false) : ((timeSlot.hour >= 4 && timeSlot.hour < 7) || (timeSlot.hour >= 16 && timeSlot.hour < 19));
                    
                    if (isPast) {
                        // éå»ã®å ´åˆã¯ã‚°ãƒ¬ãƒ¼è¡¨ç¤º
                        tableHTML += `<td class="forecast-cell past-cell">-</td>`;
                    } else if (result) {
                        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
                        const statusClass = result.status.toLowerCase();
                        const hasWarnings = result.warnings && result.warnings.length > 0;
                        const hasRecommendations = result.recommendations && result.recommendations.length > 0;
                        const hasReasons = result.reason && result.reason.length > 0;
                        
                        // å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°
                        const weatherIcons = {
                            "æ™´ã‚Œ": "â˜€ï¸",
                            "ãã‚‚ã‚Š": "â˜ï¸",
                            "å¼±ã„é›¨": "ğŸŒ¦ï¸",
                            "é›¨å¼·ã‚": "ğŸŒ§ï¸"
                        };
                        const weatherIcon = weatherIcons[result.condition] || "â˜ï¸";
                        
                        let cellContent = `
                            <div class="cell-content status-${statusClass} ${!isSprayTime ? 'not-spray-time-content' : ''}">
                                ${!isSprayTime ? '<div class="spray-time-label">æ•£å¸ƒæ™‚é–“å¸¯å¤–</div>' : ''}
                                <div class="cell-weather-icon">
                                    <span class="weather-icon">${weatherIcon}</span>
                                    <span class="weather-condition">${result.condition}</span>
                                </div>
                                <div class="cell-weather">
                                    <div class="weather-item">é¢¨: ${result.wind.toFixed(1)}m/s</div>
                                    <div class="weather-item">æ°—æ¸©: ${result.temp.toFixed(1)}Â°C</div>
                                    <div class="weather-item">é™æ°´: ${result.precip.toFixed(2)}mm</div>
                                </div>
                        `;
                        
                        if (hasReasons) {
                            cellContent += `<div class="cell-reason">${result.reason.join(', ')}</div>`;
                        }
                        
                        if (hasWarnings) {
                            result.warnings.forEach(warning => {
                                cellContent += `<div class="cell-warning">âš ï¸ ${warning}</div>`;
                            });
                        }
                        
                        if (hasRecommendations) {
                            result.recommendations.forEach(recommendation => {
                                cellContent += `<div class="cell-recommendation">ğŸ’¡ ${recommendation}</div>`;
                            });
                        }
                        
                        if (!hasReasons && !hasWarnings && !hasRecommendations && isSprayTime) {
                            cellContent += `<div class="cell-ok">âœ“ æ¡ä»¶è‰¯å¥½</div>`;
                        }
                        
                        cellContent += `</div>`;
                        
                        tableHTML += `<td class="forecast-cell" data-status="${statusClass}">${cellContent}</td>`;
                    } else {
                        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
                        if (isSprayTime) {
                            // æ•£å¸ƒå¯èƒ½æ™‚é–“å¸¯ã ãŒãƒ‡ãƒ¼ã‚¿ãŒãªã„ï¼ˆæœªæ¥ã®æ™‚é–“å¸¯ãªã©ï¼‰
                            tableHTML += `<td class="forecast-cell empty-cell">-</td>`;
                        } else {
                            // æ•£å¸ƒå¯èƒ½æ™‚é–“å¸¯å¤–
                            tableHTML += `<td class="forecast-cell not-spray-time">æ•£å¸ƒæ™‚é–“å¸¯å¤–</td>`;
                        }
                    }
                });
                
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            document.getElementById('results').classList.remove('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showError('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    document.getElementById('lat').value = position.coords.latitude.toFixed(4);
                    document.getElementById('lon').value = position.coords.longitude.toFixed(4);
                    document.getElementById('loading').classList.add('hidden');
                    fetchForecast();
                },
                (error) => {
                    document.getElementById('loading').classList.add('hidden');
                    showError('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            );
        }

        // Enterã‚­ãƒ¼ã§æ¤œç´¢
        document.getElementById('lat').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') fetchForecast();
        });
        document.getElementById('lon').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') fetchForecast();
        });
    </script>
</body>
</html>
